{% extends "page.html" %}

{# Sayfa başlığını dinamik olarak temanın adıyla ayarla #}
{% block subtitle %}{{ c.theme_data.category.name }}{% endblock %}

{% block styles %}
  {{ super() }}
  <style>
    /* CKAN'ın varsayılan başlığını ve açıklamasını gizle - "Sağlık" gibi başlıkları kaldırır */
    section.module .module-content h1.page-heading,
    section.module .module-content p {
      display: none !important;
    }

    /* "Bu Temadaki Veri Setleri" başlığını gizle */


    /* Mevcut fab-edit-theme butonu için orijinal stilini koru */
    .fab-edit-theme {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 1100;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: #28a745;
      color: white;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }
    .fab-edit-theme:hover {
      background-color: #218838;
      transform: scale(1.1);
    }

    /* Montserrat Font Tanımı (global olduğu varsayımıyla) */
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap');
    body, html, * {
        font-family: 'Montserrat', sans-serif !important;
    }

    /* Görsel önizleme için stil */
    .background-image-preview-wrapper {
      margin-top: 10px;
      border: 1px solid #ccc;
      padding: 5px;
      border-radius: 5px;
      background-color: #f9f9f9;
      display: inline-block;
    }

    .background-image-preview {
      max-width: 200px;
      height: auto;
      display: block;
    }

    .clear-image-checkbox {
      margin-top: 10px;
    }
  </style>
{% endblock %}

{% block primary_content %}
  {# Sistem yöneticisi, tema yöneticisi veya tema editörü ise, düzenleme butonu sağ altta sabit olarak görünür #}
  {% if c.is_sysadmin or (c.user_theme_role_for_this_theme and c.user_theme_role_for_this_theme in ['admin', 'editor']) %}
    <a href="{{ h.url_for('temalar_sayfasi.edit', slug=c.theme_data.category.slug) }}"
       class="fab-edit-theme"
       data-toggle="tooltip"
       data-placement="left"
       title="{{ _('Temayı Yönet') }}"> {# Orijinal metin ve tooltip korunur #}
       <i class="fa fa-cog"></i> {# Çark ikonu korunur #}
    </a>
  {% endif %}

  <section class="module">
    <div class="module-content">
      <h1 class="page-heading">
        {% if c.theme_data.category.icon %}
          <i class="fa fa-{{ c.theme_data.category.icon }}" style="color:{{ c.theme_data.category.color }}; margin-right: 15px;"></i>
        {% endif %}
        {{ c.theme_data.category.name }}
      </h1>
      {% if c.theme_data.category.description %}
        <p>{{ c.theme_data.category.description }}</p>
      {% endif %}

      <form class="form-horizontal" method="post" enctype="multipart/form-data">
        {% if c.errors %}
          <div class="alert alert-danger">
            <strong>{{ _('Lütfen formdaki hataları düzeltin:') }}</strong>
            <ul>
            {% for field, error_list in c.errors.items() %}
              {% for error in error_list %}
                <li><strong>{{ field }}:</strong> {{ error }}</li>
              {% endfor %}
            {% endfor %}
            </ul>
          </div>
        {% endif %}

        <div class="form-group">
          <label for="slug" class="col-sm-2 control-label">{{ _('Kısa İsim (Slug)') }} *</label>
          <div class="col-sm-10">
            <input type="text" id="slug" name="slug" class="form-control" value="{{ c.data.slug or '' }}" required readonly>
            <p class="help-block">{{ _('Slug değiştirilemez.') }}</p>
          </div>
        </div>

        <div class="form-group">
          <label for="name" class="col-sm-2 control-label">{{ _('Tema Adı') }} *</label>
          <div class="col-sm-10">
            <input type="text" id="name" name="name" class="form-control" value="{{ c.data.name or '' }}" required>
          </div>
        </div>

        <div class="form-group">
          <label for="description" class="col-sm-2 control-label">{{ _('Açıklama') }}</label>
          <div class="col-sm-10">
            <textarea id="description" name="description" class="form-control" rows="3">{{ c.data.description or '' }}</textarea>
          </div>
        </div>

        <div class="form-group">
          <label for="color" class="col-sm-2 control-label">{{ _('Renk Kodu') }}</label>
          <div class="col-sm-2">
            <input type="color" id="color" name="color" class="form-control" value="{{ c.data.color or '#333333' }}">
          </div>
        </div>

        <div class="form-group">
          <label for="icon" class="col-sm-2 control-label">{{ _('FontAwesome İkonu') }}</label>
          <div class="col-sm-10">
            <div class="icon-preview-wrapper">
              <input type="text" id="icon" name="icon" class="form-control" value="{{ c.data.icon or '' }}" placeholder="örn: heart, car, leaf">
              <i id="icon-preview" class="icon-preview fa"></i>
            </div>
            <p class="help-block">{{ _("Sadece ikon adını yazın. Örn: 'chart-line'") }}</p>
          </div>
        </div>

        <div class="form-group">
          <label for="background_image_upload" class="col-sm-2 control-label">{{ _('Arka Plan Görseli') }}</label>
          <div class="col-sm-10">
            {% if c.data.background_image %}
              <div class="background-image-preview-wrapper">
                <img src="/uploads/theme_background/{{ c.data.background_image }}" alt="{{ _('Mevcut Arka Plan Görseli') }}" class="background-image-preview" style="opacity: {{ c.data.opacity | default(1.0) }};">
                <p>{{ _('Mevcut Görsel') }}</p>
              </div>
              <label class="checkbox clear-image-checkbox">
                <input type="checkbox" name="clear_background_image" value="True"> {{ _('Mevcut görseli sil') }}
              </label>
              <input type="hidden" name="background_image" value="{{ c.data.background_image }}"> {# Mevcut görselin yolunu saklarız #}
            {% else %}
              <p>{{ _('Mevcut arka plan görseli yok.') }}</p>
            {% endif %}
            <input type="file" id="background_image_upload" name="background_image_upload" class="form-control">
            <p class="help-block">{{ _('Tema başlığının arkasında görünecek bir görsel yükleyin veya mevcut olanı güncelleyin.') }}</p>
          </div>
        </div>

        {# Yeni Opacity alanı eklendi #}
        <div class="form-group">
          <label for="opacity" class="col-sm-2 control-label">{{ _('Arka Plan Görseli Şeffaflığı') }}</label>
          <div class="col-sm-10">
            <input type="number" id="opacity" name="opacity" class="form-control"
                   min="0.0" max="1.0" step="0.01" value="{{ c.data.opacity | default('1.0') }}">
            <p class="help-block">{{ _('Arka plan görselinin şeffaflığı (0.0 tam şeffaf, 1.0 tam opak).') }}</p>
          </div>
        </div>

        <div class="form-group">
          <label class="col-sm-2 control-label">{{ _('Veri Setleri') }}</label>
          <div class="col-sm-10">
            <select multiple="multiple" name="dataset_ids" class="form-control" style="height: 200px;">
              {% set current_dataset_ids = c.theme_data.datasets | map(attribute='id') | list %}
              {% for dataset in c.all_datasets %}
                <option value="{{ dataset.id }}"
                        {% if dataset.id in current_dataset_ids %} selected="selected" {% endif %}>
                  {{ dataset.title or dataset.name }}
                </option>
              {% endfor %}
            </select>
            <p class="help-block">{{ _('Bu temaya ait veri setlerini seçin.') }}</p>
          </div>
        </div>

        <div class="form-group">
          <div class="col-sm-offset-2 col-sm-10">
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">
                <i class="fa fa-save"></i> {{ _('Değişiklikleri Kaydet') }}
              </button>
              <a href="{{ h.url_for('temalar_sayfasi.read', slug=c.data.slug) }}" class="btn btn-default">
                <i class="fa fa-times"></i> {{ _('İptal') }}
              </a>
              {# Sadece sistem yöneticileri temayı silebilir #}
              {% if c.is_sysadmin %}
                <button type="button" class="btn btn-danger pull-right" data-toggle="modal" data-target="#deleteThemeModal">
                  <i class="fa fa-trash"></i> {{ _('Temayı Sil') }}
                </button>
              {% endif %}
            </div>
          </div>
        </div>
      </form>
    </div>
  </section>

  {# Silme Onayı Modalı #}
  <div class="modal fade" id="deleteThemeModal" tabindex="-1" role="dialog" aria-labelledby="deleteThemeModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteThemeModalLabel">{{ _('Temayı Silmeyi Onayla') }}</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          {{ _('Bu temayı silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.') }}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">{{ _('İptal') }}</button>
          <form action="{{ h.url_for('temalar_sayfasi.delete', slug=c.data.slug) }}" method="post" style="display: inline;">
            <button type="submit" class="btn btn-danger">{{ _('Sil') }}</button>
          </form>
        </div>
      </div>
    </div>
  </div>

{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    // Icon Preview
    document.getElementById('icon').addEventListener('input', function(e) {
      const iconPreview = document.getElementById('icon-preview');
      const iconName = e.target.value.trim();

      if (iconName) {
        iconPreview.className = 'icon-preview fa fa-' + iconName;
        iconPreview.classList.add('fa-spin');
        setTimeout(() => {
          iconPreview.classList.remove('fa-spin');
        }, 500);
      } else {
        iconPreview.className = 'icon-preview fa';
      }
    });

    // Trigger icon preview on page load if value exists
    const iconInput = document.getElementById('icon');
    if (iconInput.value) {
      iconInput.dispatchEvent(new Event('input'));
    }

    // Initialize select2 for dataset multi-select
    $(document).ready(function() {
        $('select[name="dataset_ids"]').select2();
    });

    // Form submission animation
    document.querySelector('form').addEventListener('submit', function() {
      const submitBtn = document.querySelector('.btn-primary');
      submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> {{ _("Kaydediliyor...") }}';
      submitBtn.disabled = true;
    });
  </script>
{% endblock %}